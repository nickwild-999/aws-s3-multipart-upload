{"ast":null,"code":"var _jsxFileName = \"/Users/nickwild/Programming/2. Nicci Topping/serverless/aws-s3-multipart-upload2/frontend/pages/index.js\";\nvar __jsx = React.createElement;\nimport React, { Component } from 'react';\nimport axios from 'axios';\nexport default class Index extends Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      fileSelected: null,\n      uploadId: '',\n      fileName: '',\n      backendUrl: 'http://localhost:4000',\n      uploadPC: 0,\n      progressArray: [],\n      uploadProgress: 0\n    };\n  }\n\n  async fileHandler(event) {\n    try {\n      let fileSelected = event.target.files[0];\n      let fileName = fileSelected.name;\n      this.setState({\n        fileSelected\n      });\n      this.setState({\n        fileName\n      });\n    } catch (err) {\n      console.error(err, err.message);\n    }\n  }\n\n  async startUpload(event) {\n    try {\n      event.preventDefault();\n      const params = {\n        fileName: this.state.fileName,\n        fileType: this.state.fileSelected.type\n      }; // console.log(\"fs\", this.state.fileSelected)\n      // console.log(\"params:\",params)\n\n      console.log(this.state.progressArray);\n      let resp = await axios.get(`${this.state.backendUrl}/start-upload`, {\n        params\n      });\n      let {\n        uploadId\n      } = resp.data;\n      this.setState({\n        uploadId\n      });\n      this.uploadMultipartFile();\n    } catch (err) {\n      console.log(err);\n    }\n  }\n\n  async uploadMultipartFile() {\n    try {\n      // console.log('Inside uploadMultipartFile')\n      const fileSize = this.state.fileSelected.size;\n      const CHUNK_SIZE = 4900000; // <5MB\n\n      const CHUNKS_COUNT = Math.floor(fileSize / CHUNK_SIZE) + 1;\n      let promisesArray = [];\n      let start, end, blob;\n\n      for (let index = 1; index < CHUNKS_COUNT + 1; index++) {\n        start = (index - 1) * CHUNK_SIZE;\n        end = index * CHUNK_SIZE;\n        blob = index < CHUNKS_COUNT ? this.state.fileSelected.slice(start, end) : this.state.fileSelected.slice(start);\n        console.log(blob.size); // Get presigned URL for each part\n\n        let getUploadUrlResp = await axios.get(`${this.state.backendUrl}/get-upload-url`, {\n          params: {\n            fileName: this.state.fileName,\n            partNumber: index,\n            uploadId: this.state.uploadId\n          }\n        }); //new\n\n        const uploadProgressHandler = async (progressEvent, blob, index) => {\n          if (progressEvent.loaded >= progressEvent.total) return;\n          const currentProgress = Math.round(progressEvent.loaded * 100 / progressEvent.total);\n          this.setState(progressArray => {\n            this.state.progressArray[index - 1] = currentProgress;\n          });\n          const sum = this.state.progressArray.reduce((acc, curr) => acc + curr);\n          this.setState({\n            uploadProgress: Math.round(sum / CHUNKS_COUNT)\n          });\n          console.log(this.state.progressArray);\n          console.log(this.state.uploadProgress);\n        };\n\n        let {\n          presignedUrl\n        } = getUploadUrlResp.data; // console.log('   Presigned URL ' + index + ': ' + presignedUrl + ' filetype ' + this.state.fileSelected.type)\n        // Send part aws server\n\n        let uploadResp = axios.put(presignedUrl, blob, {\n          onUploadProgress: e => uploadProgressHandler(e, CHUNKS_COUNT, index),\n          headers: {\n            'Content-Type': this.state.fileSelected.type\n          }\n        });\n        promisesArray.push(uploadResp);\n      }\n\n      let resolvedArray = await Promise.all(promisesArray);\n      console.log(resolvedArray, ' resolvedArray');\n      let uploadPartsArray = [];\n      resolvedArray.forEach((resolvedPromise, index) => {\n        uploadPartsArray.push({\n          ETag: resolvedPromise.headers.etag,\n          PartNumber: index + 1\n        });\n      });\n      console.log(uploadPartsArray); // CompleteMultipartUpload in the backend server\n\n      let completeUploadResp = await axios.post(`${this.state.backendUrl}/complete-upload`, {\n        params: {\n          fileName: this.state.fileName,\n          parts: uploadPartsArray,\n          uploadId: this.state.uploadId\n        }\n      });\n      console.log(completeUploadResp.data, \"complete upload response\");\n    } catch (err) {\n      console.log(err);\n    }\n  }\n\n  render() {\n    return __jsx(\"div\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 133,\n        columnNumber: 7\n      }\n    }, __jsx(\"form\", {\n      onSubmit: this.startUpload.bind(this),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 134,\n        columnNumber: 9\n      }\n    }, __jsx(\"div\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 135,\n        columnNumber: 11\n      }\n    }, __jsx(\"p\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 136,\n        columnNumber: 13\n      }\n    }, \"Upload Dataset:\"), __jsx(\"input\", {\n      type: \"file\",\n      id: \"file\",\n      onChange: this.fileHandler.bind(this),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 137,\n        columnNumber: 13\n      }\n    }), __jsx(\"button\", {\n      type: \"submit\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 138,\n        columnNumber: 13\n      }\n    }, \"Upload\"), __jsx(\"div\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 141,\n        columnNumber: 13\n      }\n    }, this.state.uploadProgress, \"% uploaded\"))));\n  }\n\n}","map":{"version":3,"sources":["/Users/nickwild/Programming/2. Nicci Topping/serverless/aws-s3-multipart-upload2/frontend/pages/index.js"],"names":["React","Component","axios","Index","constructor","props","state","fileSelected","uploadId","fileName","backendUrl","uploadPC","progressArray","uploadProgress","fileHandler","event","target","files","name","setState","err","console","error","message","startUpload","preventDefault","params","fileType","type","log","resp","get","data","uploadMultipartFile","fileSize","size","CHUNK_SIZE","CHUNKS_COUNT","Math","floor","promisesArray","start","end","blob","index","slice","getUploadUrlResp","partNumber","uploadProgressHandler","progressEvent","loaded","total","currentProgress","round","sum","reduce","acc","curr","presignedUrl","uploadResp","put","onUploadProgress","e","headers","push","resolvedArray","Promise","all","uploadPartsArray","forEach","resolvedPromise","ETag","etag","PartNumber","completeUploadResp","post","parts","render","bind"],"mappings":";;AAAA,OAAOA,KAAP,IAAgBC,SAAhB,QAAiC,OAAjC;AACA,OAAOC,KAAP,MAAkB,OAAlB;AAEA,eAAe,MAAMC,KAAN,SAAoBF,SAApB,CAA8B;AAC3CG,EAAAA,WAAW,CAACC,KAAD,EAAQ;AACjB,UAAMA,KAAN;AACA,SAAKC,KAAL,GAAa;AACXC,MAAAA,YAAY,EAAE,IADH;AAEXC,MAAAA,QAAQ,EAAE,EAFC;AAGXC,MAAAA,QAAQ,EAAE,EAHC;AAIXC,MAAAA,UAAU,EAAE,uBAJD;AAKXC,MAAAA,QAAQ,EAAC,CALE;AAMXC,MAAAA,aAAa,EAAC,EANH;AAOXC,MAAAA,cAAc,EAAC;AAPJ,KAAb;AASD;;AAED,QAAMC,WAAN,CAAkBC,KAAlB,EAAyB;AACvB,QAAI;AACF,UAAIR,YAAY,GAAGQ,KAAK,CAACC,MAAN,CAAaC,KAAb,CAAmB,CAAnB,CAAnB;AACA,UAAIR,QAAQ,GAAGF,YAAY,CAACW,IAA5B;AACA,WAAKC,QAAL,CAAc;AAAEZ,QAAAA;AAAF,OAAd;AACA,WAAKY,QAAL,CAAc;AAAEV,QAAAA;AAAF,OAAd;AACD,KALD,CAKE,OAAOW,GAAP,EAAY;AACZC,MAAAA,OAAO,CAACC,KAAR,CAAcF,GAAd,EAAmBA,GAAG,CAACG,OAAvB;AACD;AACF;;AAED,QAAMC,WAAN,CAAkBT,KAAlB,EAAyB;AACvB,QAAI;AACFA,MAAAA,KAAK,CAACU,cAAN;AACA,YAAMC,MAAM,GAAG;AACbjB,QAAAA,QAAQ,EAAE,KAAKH,KAAL,CAAWG,QADR;AAEbkB,QAAAA,QAAQ,EAAE,KAAKrB,KAAL,CAAWC,YAAX,CAAwBqB;AAFrB,OAAf,CAFE,CAMF;AACA;;AACAP,MAAAA,OAAO,CAACQ,GAAR,CAAY,KAAKvB,KAAL,CAAWM,aAAvB;AAEA,UAAIkB,IAAI,GAAG,MAAM5B,KAAK,CAAC6B,GAAN,CAAW,GAAE,KAAKzB,KAAL,CAAWI,UAAW,eAAnC,EAAmD;AAAEgB,QAAAA;AAAF,OAAnD,CAAjB;AACA,UAAI;AAAElB,QAAAA;AAAF,UAAesB,IAAI,CAACE,IAAxB;AACA,WAAKb,QAAL,CAAc;AAAEX,QAAAA;AAAF,OAAd;AACA,WAAKyB,mBAAL;AAED,KAfD,CAeE,OAAOb,GAAP,EAAY;AACZC,MAAAA,OAAO,CAACQ,GAAR,CAAYT,GAAZ;AACD;AACF;;AAED,QAAMa,mBAAN,GAA4B;AAC1B,QAAI;AACF;AACA,YAAMC,QAAQ,GAAG,KAAK5B,KAAL,CAAWC,YAAX,CAAwB4B,IAAzC;AACA,YAAMC,UAAU,GAAG,OAAnB,CAHE,CAGyB;;AAC3B,YAAMC,YAAY,GAAGC,IAAI,CAACC,KAAL,CAAWL,QAAQ,GAAGE,UAAtB,IAAoC,CAAzD;AAEA,UAAII,aAAa,GAAG,EAApB;AACA,UAAIC,KAAJ,EAAWC,GAAX,EAAgBC,IAAhB;;AAEA,WAAK,IAAIC,KAAK,GAAG,CAAjB,EAAoBA,KAAK,GAAGP,YAAY,GAAG,CAA3C,EAA8CO,KAAK,EAAnD,EAAuD;AACrDH,QAAAA,KAAK,GAAG,CAACG,KAAK,GAAG,CAAT,IAAcR,UAAtB;AACAM,QAAAA,GAAG,GAAIE,KAAD,GAAUR,UAAhB;AACAO,QAAAA,IAAI,GAAIC,KAAK,GAAGP,YAAT,GAAyB,KAAK/B,KAAL,CAAWC,YAAX,CAAwBsC,KAAxB,CAA8BJ,KAA9B,EAAqCC,GAArC,CAAzB,GAAqE,KAAKpC,KAAL,CAAWC,YAAX,CAAwBsC,KAAxB,CAA8BJ,KAA9B,CAA5E;AAEApB,QAAAA,OAAO,CAACQ,GAAR,CAAYc,IAAI,CAACR,IAAjB,EALqD,CAMrD;;AACA,YAAIW,gBAAgB,GAAG,MAAM5C,KAAK,CAAC6B,GAAN,CAAW,GAAE,KAAKzB,KAAL,CAAWI,UAAW,iBAAnC,EAAqD;AAChFgB,UAAAA,MAAM,EAAE;AACNjB,YAAAA,QAAQ,EAAE,KAAKH,KAAL,CAAWG,QADf;AAENsC,YAAAA,UAAU,EAAEH,KAFN;AAGNpC,YAAAA,QAAQ,EAAE,KAAKF,KAAL,CAAWE;AAHf;AADwE,SAArD,CAA7B,CAPqD,CAezD;;AACA,cAAMwC,qBAAqB,GAAC,OAAMC,aAAN,EAAqBN,IAArB,EAA2BC,KAA3B,KAAoC;AAC9D,cAAIK,aAAa,CAACC,MAAd,IAAwBD,aAAa,CAACE,KAA1C,EAAiD;AACjD,gBAAMC,eAAe,GAAGd,IAAI,CAACe,KAAL,CAAYJ,aAAa,CAACC,MAAd,GAAuB,GAAxB,GAA+BD,aAAa,CAACE,KAAxD,CAAxB;AACA,eAAKhC,QAAL,CAAcP,aAAa,IAAG;AAAC,iBAAKN,KAAL,CAAWM,aAAX,CAAyBgC,KAAK,GAAC,CAA/B,IAAoCQ,eAApC;AAAoD,WAAnF;AACE,gBAAME,GAAG,GAAG,KAAKhD,KAAL,CAAWM,aAAX,CAAyB2C,MAAzB,CAAgC,CAACC,GAAD,EAAMC,IAAN,KAAeD,GAAG,GAAGC,IAArD,CAAZ;AACA,eAAKtC,QAAL,CAAc;AAACN,YAAAA,cAAc,EAACyB,IAAI,CAACe,KAAL,CAAWC,GAAG,GAAGjB,YAAjB;AAAhB,WAAd;AACAhB,UAAAA,OAAO,CAACQ,GAAR,CAAY,KAAKvB,KAAL,CAAWM,aAAvB;AACAS,UAAAA,OAAO,CAACQ,GAAR,CAAY,KAAKvB,KAAL,CAAWO,cAAvB;AACH,SARD;;AASI,YAAI;AAAE6C,UAAAA;AAAF,YAAmBZ,gBAAgB,CAACd,IAAxC,CAzBqD,CA0BrD;AAEA;;AACA,YAAI2B,UAAU,GAAGzD,KAAK,CAAC0D,GAAN,CAAUF,YAAV,EAAwBf,IAAxB,EAA8B;AAC7CkB,UAAAA,gBAAgB,EAAGC,CAAD,IAAOd,qBAAqB,CAACc,CAAD,EAAIzB,YAAJ,EAAkBO,KAAlB,CADD;AAE7CmB,UAAAA,OAAO,EAAE;AACP,4BAAgB,KAAKzD,KAAL,CAAWC,YAAX,CAAwBqB;AADjC;AAFoC,SAA9B,CAAjB;AAOAY,QAAAA,aAAa,CAACwB,IAAd,CAAmBL,UAAnB;AAED;;AAED,UAAIM,aAAa,GAAG,MAAMC,OAAO,CAACC,GAAR,CAAY3B,aAAZ,CAA1B;AACAnB,MAAAA,OAAO,CAACQ,GAAR,CAAYoC,aAAZ,EAA2B,gBAA3B;AAEA,UAAIG,gBAAgB,GAAG,EAAvB;AACAH,MAAAA,aAAa,CAACI,OAAd,CAAsB,CAACC,eAAD,EAAkB1B,KAAlB,KAA4B;AAChDwB,QAAAA,gBAAgB,CAACJ,IAAjB,CAAsB;AACpBO,UAAAA,IAAI,EAAED,eAAe,CAACP,OAAhB,CAAwBS,IADV;AAEpBC,UAAAA,UAAU,EAAE7B,KAAK,GAAG;AAFA,SAAtB;AAKD,OAND;AAOAvB,MAAAA,OAAO,CAACQ,GAAR,CAAYuC,gBAAZ,EA5DE,CA+DF;;AACA,UAAIM,kBAAkB,GAAG,MAAMxE,KAAK,CAACyE,IAAN,CAAY,GAAE,KAAKrE,KAAL,CAAWI,UAAW,kBAApC,EAAuD;AACpFgB,QAAAA,MAAM,EAAE;AACNjB,UAAAA,QAAQ,EAAE,KAAKH,KAAL,CAAWG,QADf;AAENmE,UAAAA,KAAK,EAAER,gBAFD;AAGN5D,UAAAA,QAAQ,EAAE,KAAKF,KAAL,CAAWE;AAHf;AAD4E,OAAvD,CAA/B;AAQAa,MAAAA,OAAO,CAACQ,GAAR,CAAY6C,kBAAkB,CAAC1C,IAA/B,EAAqC,0BAArC;AAGD,KA3ED,CA2EE,OAAOZ,GAAP,EAAY;AACZC,MAAAA,OAAO,CAACQ,GAAR,CAAYT,GAAZ;AACD;AACF;;AAEDyD,EAAAA,MAAM,GAAG;AACP,WACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OACE;AAAM,MAAA,QAAQ,EAAE,KAAKrD,WAAL,CAAiBsD,IAAjB,CAAsB,IAAtB,CAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,yBADF,EAEE;AAAO,MAAA,IAAI,EAAC,MAAZ;AAAmB,MAAA,EAAE,EAAC,MAAtB;AAA6B,MAAA,QAAQ,EAAE,KAAKhE,WAAL,CAAiBgE,IAAjB,CAAsB,IAAtB,CAAvC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAFF,EAGE;AAAQ,MAAA,IAAI,EAAC,QAAb;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gBAHF,EAME;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAAM,KAAKxE,KAAL,CAAWO,cAAjB,eANF,CADF,CADF,CADF;AAcD;;AA9I0C","sourcesContent":["import React, { Component } from 'react'\nimport axios from 'axios'\n\nexport default class Index extends Component {\n  constructor(props) {\n    super(props)\n    this.state = {\n      fileSelected: null,\n      uploadId: '',\n      fileName: '',\n      backendUrl: 'http://localhost:4000',\n      uploadPC:0,\n      progressArray:[],\n      uploadProgress:0\n    }\n  }\n\n  async fileHandler(event) {\n    try {\n      let fileSelected = event.target.files[0]\n      let fileName = fileSelected.name\n      this.setState({ fileSelected })\n      this.setState({ fileName })\n    } catch (err) {\n      console.error(err, err.message) \n    }\n  }\n  \n  async startUpload(event) {\n    try {\n      event.preventDefault()\n      const params = {\n        fileName: this.state.fileName,\n        fileType: this.state.fileSelected.type\n      };\n      // console.log(\"fs\", this.state.fileSelected)\n      // console.log(\"params:\",params)\n      console.log(this.state.progressArray)\n\n      let resp = await axios.get(`${this.state.backendUrl}/start-upload`, { params })\n      let { uploadId } = resp.data\n      this.setState({ uploadId })\n      this.uploadMultipartFile()\n\n    } catch (err) {\n      console.log(err)\n    }\n  }\n\n  async uploadMultipartFile() {\n    try {\n      // console.log('Inside uploadMultipartFile')\n      const fileSize = this.state.fileSelected.size\n      const CHUNK_SIZE = 4900000 // <5MB\n      const CHUNKS_COUNT = Math.floor(fileSize / CHUNK_SIZE) + 1\n\n      let promisesArray = []\n      let start, end, blob\n\n      for (let index = 1; index < CHUNKS_COUNT + 1; index++) {\n        start = (index - 1) * CHUNK_SIZE\n        end = (index) * CHUNK_SIZE\n        blob = (index < CHUNKS_COUNT) ? this.state.fileSelected.slice(start, end) : this.state.fileSelected.slice(start)\n\n        console.log(blob.size)\n        // Get presigned URL for each part\n        let getUploadUrlResp = await axios.get(`${this.state.backendUrl}/get-upload-url`, {\n          params: {\n            fileName: this.state.fileName,\n            partNumber: index,\n            uploadId: this.state.uploadId\n          }\n        })\n\n    //new\n    const uploadProgressHandler=async(progressEvent, blob, index) =>{\n      if (progressEvent.loaded >= progressEvent.total) return;\n      const currentProgress = Math.round((progressEvent.loaded * 100) / progressEvent.total);  \n      this.setState(progressArray =>{this.state.progressArray[index-1] = currentProgress});\n        const sum = this.state.progressArray.reduce((acc, curr) => acc + curr);\n        this.setState({uploadProgress:Math.round(sum / CHUNKS_COUNT)});\n        console.log(this.state.progressArray)\n        console.log(this.state.uploadProgress)\n    }\n        let { presignedUrl } = getUploadUrlResp.data\n        // console.log('   Presigned URL ' + index + ': ' + presignedUrl + ' filetype ' + this.state.fileSelected.type)\n        \n        // Send part aws server\n        let uploadResp = axios.put(presignedUrl, blob, {\n          onUploadProgress: (e) => uploadProgressHandler(e, CHUNKS_COUNT, index),\n          headers: {\n            'Content-Type': this.state.fileSelected.type\n          },\n        })\n        \n        promisesArray.push(uploadResp)\n        \n      }\n\n      let resolvedArray = await Promise.all(promisesArray)\n      console.log(resolvedArray, ' resolvedArray')\n\n      let uploadPartsArray = []\n      resolvedArray.forEach((resolvedPromise, index) => {\n        uploadPartsArray.push({\n          ETag: resolvedPromise.headers.etag,\n          PartNumber: index + 1\n        })\n\n      })\n      console.log(uploadPartsArray)\n\n\n      // CompleteMultipartUpload in the backend server\n      let completeUploadResp = await axios.post(`${this.state.backendUrl}/complete-upload`, {\n        params: {\n          fileName: this.state.fileName,\n          parts: uploadPartsArray,\n          uploadId: this.state.uploadId\n        }\n      })\n   \n      console.log(completeUploadResp.data, \"complete upload response\")\n\n\n    } catch (err) {\n      console.log(err)\n    }\n  }\n\n  render() {\n    return (\n      <div>\n        <form onSubmit={this.startUpload.bind(this)}>\n          <div>\n            <p>Upload Dataset:</p>\n            <input type='file' id='file' onChange={this.fileHandler.bind(this)} />\n            <button type='submit'>\n              Upload\n            </button>\n            <div>{this.state.uploadProgress}% uploaded</div>\n          </div>\n        </form>\n      </div>\n    )\n  }\n}"]},"metadata":{},"sourceType":"module"}